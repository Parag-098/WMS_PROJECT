{% extends "inventory/base.html" %}

{% block title %}Receive Inventory - WMS{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <h2>Receive Inventory</h2>
        <p class="text-muted">Add multiple batches for a single item</p>
    </div>
</div>

<div class="row mt-3">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5>Batch Entry</h5>
            </div>
            <div class="card-body">
                <form id="receive-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="preview">
                    
                    <div class="mb-3">
                        <label for="item-select" class="form-label">Item <span class="text-danger">*</span></label>
                        <select name="item_id" id="item-select" class="form-select" required>
                            <option value="">-- Select Item --</option>
                            {% for item in items %}
                            <option value="{{ item.pk }}">{{ item.sku }} - {{ item.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6>Batch Rows</h6>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addBatchRow()">+ Add Row</button>
                    </div>

                    <div id="batch-rows-container">
                        <div class="batch-row mb-2 p-2 border rounded">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label small">Lot Number</label>
                                    <input type="text" name="batch_0_lot_no" class="form-control form-control-sm" placeholder="LOT-001" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">Quantity</label>
                                    <input type="number" name="batch_0_qty" class="form-control form-control-sm" placeholder="100" step="0.001" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">Expiry Date</label>
                                    <input type="date" name="batch_0_expiry" class="form-control form-control-sm">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="button" class="btn btn-sm btn-danger w-100" onclick="removeBatchRow(this)" disabled>Remove</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="button" 
                                class="btn btn-primary"
                                hx-post="{% url 'inventory:receive' %}"
                                hx-include="#receive-form"
                                hx-target="#preview-container"
                                hx-indicator="#preview-loading">
                            Preview & Validate
                        </button>
                        <span id="preview-loading" class="htmx-indicator spinner-border spinner-border-sm ms-2" role="status"></span>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div id="preview-container" class="sticky-top" style="top: 80px;">
            <div class="card">
                <div class="card-header bg-light">
                    <h5>Preview</h5>
                </div>
                <div class="card-body text-center text-muted">
                    Click "Preview & Validate" to see batch summary
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let rowCounter = 1;

function addBatchRow() {
    const container = document.getElementById('batch-rows-container');
    const newRow = document.createElement('div');
    newRow.className = 'batch-row mb-2 p-2 border rounded';
    newRow.innerHTML = `
        <div class="row g-2">
            <div class="col-md-4">
                <label class="form-label small">Lot Number</label>
                <input type="text" name="batch_${rowCounter}_lot_no" class="form-control form-control-sm" placeholder="LOT-00${rowCounter + 1}" required>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Quantity</label>
                <input type="number" name="batch_${rowCounter}_qty" class="form-control form-control-sm" placeholder="100" step="0.001" required>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Expiry Date</label>
                <input type="date" name="batch_${rowCounter}_expiry" class="form-control form-control-sm">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-sm btn-danger w-100" onclick="removeBatchRow(this)">Remove</button>
            </div>
        </div>
    `;
    container.appendChild(newRow);
    rowCounter++;
    updateRemoveButtons();
}

function removeBatchRow(button) {
    const row = button.closest('.batch-row');
    row.remove();
    updateRemoveButtons();
}

function updateRemoveButtons() {
    const rows = document.querySelectorAll('.batch-row');
    rows.forEach((row, index) => {
        const removeBtn = row.querySelector('button[onclick*="removeBatchRow"]');
        if (rows.length === 1) {
            removeBtn.disabled = true;
        } else {
            removeBtn.disabled = false;
        }
    });
}
</script>
{% endblock %}
