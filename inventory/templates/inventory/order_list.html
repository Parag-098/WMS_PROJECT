{% extends "inventory/base.html" %}

{% block title %}Orders - WMS{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Orders</h1>
        <a href="{% url 'inventory:order-create' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Create Order
        </a>
    </div>

    <!-- Status Filter -->
    <div class="mb-3">
        <div class="btn-group" role="group">
            <a href="{% url 'inventory:order-list' %}" class="btn btn-sm btn-outline-secondary {% if not request.GET.status %}active{% endif %}">All</a>
            <a href="?status=new" class="btn btn-sm btn-outline-secondary {% if request.GET.status == 'new' %}active{% endif %}">New</a>
            <a href="?status=allocated" class="btn btn-sm btn-outline-secondary {% if request.GET.status == 'allocated' %}active{% endif %}">Allocated</a>
            <a href="?status=picked" class="btn btn-sm btn-outline-secondary {% if request.GET.status == 'picked' %}active{% endif %}">Picked</a>
            <a href="?status=shipped" class="btn btn-sm btn-outline-secondary {% if request.GET.status == 'shipped' %}active{% endif %}">Shipped</a>
            <a href="?status=delivered" class="btn btn-sm btn-outline-secondary {% if request.GET.status == 'delivered' %}active{% endif %}">Delivered</a>
            <a href="?status=cancelled" class="btn btn-sm btn-outline-secondary {% if request.GET.status == 'cancelled' %}active{% endif %}">Cancelled</a>
        </div>
    </div>

    {% if orders %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Order #</th>
                    <th>Customer</th>
                    <th>Status</th>
                    <th>Items</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    <td>
                        <a href="{% url 'inventory:order-detail' order.pk %}">{{ order.order_no }}</a>
                    </td>
                    <td>{{ order.customer_name|default:"â€”" }}</td>
                    <td>
                        {% if order.status == 'new' %}
                            <span class="badge bg-primary">New</span>
                        {% elif order.status == 'allocated' %}
                            <span class="badge bg-info">Allocated</span>
                        {% elif order.status == 'picked' %}
                            <span class="badge bg-warning">Picked</span>
                        {% elif order.status == 'shipped' %}
                            <span class="badge bg-success">Shipped</span>
                        {% elif order.status == 'delivered' %}
                            <span class="badge bg-success">Delivered</span>
                        {% elif order.status == 'cancelled' %}
                            <span class="badge bg-secondary">Cancelled</span>
                        {% endif %}
                    </td>
                    <td>{{ order.items.count }} line(s)</td>
                    <td>{{ order.created_at|date:"Y-m-d H:i" }}</td>
                    <td>
                        <a href="{% url 'inventory:order-detail' order.pk %}" class="btn btn-sm btn-info">
                            <i class="bi bi-eye"></i> View
                        </a>
                        {% if user.is_staff %}
                        <a href="{% url 'inventory:order-update' order.pk %}" class="btn btn-sm btn-primary">
                            <i class="bi bi-pencil"></i> Edit
                        </a>
                        {% if order.status != 'cancelled' and order.status != 'delivered' %}
                        <form method="post" action="{% url 'inventory:order-cancel' order.pk %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('Cancel this order?');">
                                <i class="bi bi-x-circle"></i> Cancel
                            </button>
                        </form>
                        {% endif %}
                        <a href="{% url 'inventory:order-delete' order.pk %}" class="btn btn-sm btn-danger">
                            <i class="bi bi-trash"></i> Delete
                        </a>
                        {% endif %}
                        {% if order.status == 'new' %}
                        <a href="{% url 'inventory:order-allocate' order.pk %}" class="btn btn-sm btn-success">
                            <i class="bi bi-check-circle"></i> Allocate
                        </a>
                        {% elif order.status == 'allocated' and user.is_staff %}
                        <a href="{% url 'inventory:order-deallocate' order.pk %}" class="btn btn-sm btn-secondary" title="Deallocate stock">
                            <i class="bi bi-arrow-counterclockwise"></i> Deallocate
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page=1">First</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
            {% endif %}

            <li class="page-item active"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>

            {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last</a></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> No orders found. 
        <a href="{% url 'inventory:order-create' %}">Create your first order</a>
    </div>
    {% endif %}
</div>
{% endblock %}
